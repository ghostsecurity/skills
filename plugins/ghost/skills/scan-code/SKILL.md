---
name: scan-code
description: |
  Ghost Security - Static application security testing (SAST) scanner.
  Runs a multi-phase analysis pipeline that performs a code security vulnerability analysis.
  Supports full-repo scans and commit-diff scans.
  Use when the user wants to scan code with ghost for security issues, find vulnerabilities, run security analysis, or review a codebase for risks.
allowed-tools: Read, Glob, Grep, Bash, Task, TodoRead, TodoWrite, TaskCreate, TaskUpdate, TaskGet, TaskList
argument-hint: "[provided-extra-details]"
context: fork
model: sonnet
disable-model-invocation: false
user-invocable: true
---

# Overview - Ghost Security Code Scanner

This skill follows a phased, step by step methodology for understanding a codebase's structure, dynamically deciding what to scan for, and carrying out a thorough finding discovery analysis with finding verification.


## Defaults

These defaults apply unless overridden by user/agent arguments below.

- **repo_path**: the current working directory
- **cache_dir**: `.ghost/cache` — global, repo-level cache (reused across scans). Holds codebase metadata.
- **scan_dir**: `.ghost/scans/<scan_id>` — per-scan working directory. Holds the scan plan, findings, and final report for a single scan run.
- **scan_id**: compact timestamp generated by the orchestrator at the start of each run, formatted as `YYYYMMDD-HHMMSS` (e.g., `20260205-203000`). Can be overridden via arguments.

The orchestrator passes only the path prefixes each subagent needs. The context subagent only needs `repo_path` and `cache_dir`. All other subagents need `repo_path`, `cache_dir`, and `scan_dir`.

## User or Agent Provided Extra Details

Any values here override the defaults above.

$ARGUMENTS

---

## Task Definition Rules

- Each phase must be completed according to the defined order
- Use your task tracking capability to organize the work
- Each phase is meant to be run by a dedicated subagent with its own context window
- Each phase will report back with one or more file/directory paths as its output
- Update the task list as phases are completed

## Orchestrator: How to Run Each Step

**CRITICAL**: You are an orchestrator. You do NOT read agent files or execute their logic yourself. You ONLY spawn subagents and wait for their results. Each step below gives you a dispatch prompt — pass that prompt verbatim to a new subagent. The subagent will read its own agent file and do the work.

For each step in the workflow:

1. **Dispatch**: Spawn a subagent whose prompt is the dispatch prompt shown in the step. Use your agent/subagent spawning capability — do NOT use Bash, shell commands, or file writes to build prompts. Do NOT read the agent .md files yourself.

2. **Confirm completion**: Every subagent will end its response with a structured `## Outputs` block. Verify the step completed successfully before moving to the next step.

### Error Handling

If a subagent fails or returns an error instead of a valid `## Outputs` block:
- Retry the step **once** with the same inputs.
- If it fails again, **stop the workflow** and report the failure to the user, including which step failed and the subagent's error output.

## Scan Workflow

Track your progress:

Scan Progress Task Tracking:
- [ ] Step 1: Delegate to a Subagent: Gather codebase **context** (depends on nothing)
- [ ] Step 2: Delegate to a Subagent: **Plan** what to scan (depends on step 1)
- [ ] Step 3: Delegate to a Subagent: **Analyze** code for vulnerabilities (depends on step 2)
- [ ] Step 4: Delegate to a Subagent: **Verify** findings (depends on step 3)
- [ ] Step 5: Delegate to a Subagent: **Summarize** results (depends on step 4)

## Steps Index

**Step 1: Gather codebase context**

Depends On: None
Writes output to: `<cache_dir>/repo.md`

Dispatch prompt:
```
Read and follow the instructions in agents/context/agent.md.

## Inputs
- repo_path: <repo_path>
- cache_dir: <cache_dir>
```

**Step 2: Plan what to scan**

Depends On: Step 1 must successfully complete to proceed
Writes output to: `<scan_dir>/plan.md`
Note: If `base_commit` and `head_commit` are provided in `$ARGUMENTS`, include them in the dispatch prompt. Omit them for a fresh scan.

Dispatch prompt:
```
Read and follow the instructions in agents/plan/agent.md.

## Inputs
- repo_path: <repo_path>
- cache_dir: <cache_dir>
- scan_dir: <scan_dir>
- base_commit: <base_commit>
- head_commit: <head_commit>
```

**Step 3: Analyze code for vulnerabilities**

Depends On: Step 2 must successfully complete to proceed
Writes output to: `<scan_dir>/findings/`

Dispatch prompt:
```
Read and follow the instructions in agents/analyze/agent.md.

## Inputs
- repo_path: <repo_path>
- cache_dir: <cache_dir>
- scan_dir: <scan_dir>
```

**Step 4: Verify findings**

Depends On: Step 3 must successfully complete to proceed
Writes output to: `<scan_dir>/findings/` (updates or deletes finding files)

Dispatch prompt:
```
Read and follow the instructions in agents/verify/agent.md.

## Inputs
- repo_path: <repo_path>
- cache_dir: <cache_dir>
- scan_dir: <scan_dir>
```

**Step 5: Summarize results**

Depends On: Step 4 must successfully complete to proceed
Writes output to: `<scan_dir>/report.md`

Dispatch prompt:
```
Read and follow the instructions in agents/summarize/agent.md.

## Inputs
- repo_path: <repo_path>
- cache_dir: <cache_dir>
- scan_dir: <scan_dir>
```
